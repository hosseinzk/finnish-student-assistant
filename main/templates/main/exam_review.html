{% extends "main/base.html" %}
{% load exam_tags %}

{% block title %}<title>{{ submission.exam_name }} - Tarkastelu</title>{% endblock %}

{% block css %}
<!-- MathJax for rendering math formulas -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
    }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
    .review-container {
        min-height: calc(100vh - 48px);
        padding: 40px 20px;
        background: var(--color-bg-gradient);
    }

    .review-content {
        max-width: 800px;
        margin: 0 auto;
    }

    .review-header {
        background: var(--color-bg-white);
        border-radius: var(--radius-xl);
        padding: 35px;
        margin-bottom: 30px;
        box-shadow: var(--shadow-sm);
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        gap: 20px;
        flex-wrap: wrap;
    }

    .exam-title {
        font-size: var(--text-2xl);
        font-weight: 600;
        color: var(--color-text-primary);
        font-family: var(--font-family-primary);
        letter-spacing: var(--tracking-tight);
        margin: 0;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--color-bg-light);
        color: var(--color-text-primary);
        border-radius: var(--radius-md);
        text-decoration: none;
        font-size: var(--text-sm);
        font-weight: 500;
        transition: var(--transition-normal);
    }

    .back-link:hover {
        background: var(--color-primary);
        color: white;
    }

    .exam-description {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        margin-bottom: 20px;
        line-height: var(--leading-relaxed);
    }

    .exam-stats {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 1px solid var(--color-border-light);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-label {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
    }

    .stat-value {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--color-primary);
    }

    /* Grading Summary Card */
    .grading-summary {
        background: linear-gradient(135deg, var(--color-primary), #4a8a96);
        border-radius: var(--radius-xl);
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        box-shadow: var(--shadow-lg);
    }

    .grading-summary.not-graded {
        background: linear-gradient(135deg, #94a3b8, #64748b);
    }

    .grading-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .grading-title {
        font-size: var(--text-lg);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .grading-badge {
        padding: 4px 12px;
        background: rgba(255,255,255,0.2);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: 600;
    }

    .grade-display {
        text-align: center;
        padding: 20px 0;
    }

    .grade-percentage {
        font-size: 64px;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 10px;
    }

    .grade-points {
        font-size: var(--text-lg);
        opacity: 0.9;
    }

    .grade-bar {
        height: 8px;
        background: rgba(255,255,255,0.3);
        border-radius: var(--radius-full);
        overflow: hidden;
        margin-top: 20px;
    }

    .grade-bar-fill {
        height: 100%;
        background: white;
        border-radius: var(--radius-full);
        transition: width 0.5s ease;
    }

    .not-graded-message {
        text-align: center;
        padding: 20px;
    }

    .not-graded-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .not-graded-text {
        font-size: var(--text-lg);
        opacity: 0.9;
    }

    /* Question Cards */
    .questions-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .question-card {
        background: var(--color-bg-white);
        border-radius: var(--radius-lg);
        padding: 30px;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--color-primary);
    }

    .question-card.graded-correct {
        border-left-color: #10b981;
    }

    .question-card.graded-partial {
        border-left-color: #f59e0b;
    }

    .question-card.graded-incorrect {
        border-left-color: #ef4444;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .question-number {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--color-primary);
        background: rgba(90, 155, 168, 0.1);
        padding: 4px 12px;
        border-radius: var(--radius-full);
    }

    .question-points {
        font-size: var(--text-sm);
        font-weight: 600;
        padding: 4px 12px;
        border-radius: var(--radius-full);
    }

    .points-full {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .points-partial {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .points-zero {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .question-type {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
    }

    .question-text {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 20px;
        line-height: var(--leading-relaxed);
    }

    .answer-section {
        background: var(--color-bg-light);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 15px;
    }

    .answer-label {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
        margin-bottom: 10px;
    }

    .answer-text {
        font-size: var(--text-base);
        color: var(--color-text-primary);
        line-height: var(--leading-relaxed);
        white-space: pre-wrap;
    }

    .answer-empty {
        font-size: var(--text-base);
        color: var(--color-text-muted);
        font-style: italic;
    }

    /* Grading Feedback Section */
    .grading-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px dashed var(--color-border-light);
    }

    .feedback-box {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 15px;
    }

    .feedback-box.correct {
        background: #d1fae5;
        border-color: #6ee7b7;
    }

    .feedback-box.incorrect {
        background: #fee2e2;
        border-color: #fca5a5;
    }

    .feedback-label {
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .feedback-label.correct {
        color: #059669;
    }

    .feedback-label.partial {
        color: #d97706;
    }

    .feedback-label.incorrect {
        color: #dc2626;
    }

    .feedback-text {
        font-size: var(--text-base);
        color: var(--color-text-primary);
        line-height: var(--leading-relaxed);
    }

    .correct-answer-box {
        background: #dbeafe;
        border: 1px solid #93c5fd;
        border-radius: var(--radius-md);
        padding: 16px;
    }

    .correct-answer-label {
        font-size: var(--text-xs);
        font-weight: 600;
        color: #1d4ed8;
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .correct-answer-text {
        font-size: var(--text-base);
        color: var(--color-text-primary);
        line-height: var(--leading-relaxed);
    }

    /* Choices for multiple choice */
    .choices-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }

    .choice-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--color-bg-light);
        border-radius: var(--radius-md);
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        border: 2px solid transparent;
    }

    .choice-item.selected {
        background: rgba(90, 155, 168, 0.15);
        border-color: var(--color-primary);
        color: var(--color-text-primary);
    }

    .choice-marker {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 2px solid var(--color-border);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .choice-item.selected .choice-marker {
        background: var(--color-primary);
        border-color: var(--color-primary);
    }

    .choice-marker svg {
        width: 12px;
        height: 12px;
        color: white;
        display: none;
    }

    .choice-item.selected .choice-marker svg {
        display: block;
    }

    .no-answer {
        padding: 15px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: var(--radius-md);
        color: var(--color-error);
        font-size: var(--text-sm);
        text-align: center;
    }

    .footer-actions {
        margin-top: 40px;
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 14px 30px;
        border-radius: var(--radius-md);
        font-size: var(--text-base);
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: var(--transition-normal);
        font-family: var(--font-family-primary);
    }

    .action-btn-primary {
        background: var(--color-primary);
        color: white;
        border: none;
    }

    .action-btn-primary:hover {
        background: var(--color-primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-primary);
    }

    .action-btn-secondary {
        background: var(--color-bg-white);
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
    }

    .action-btn-secondary:hover {
        background: var(--color-primary);
        color: white;
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .header-top {
            flex-direction: column;
        }

        .exam-stats {
            flex-direction: column;
            gap: 15px;
        }

        .question-card {
            padding: 20px;
        }

        .footer-actions {
            flex-direction: column;
        }

        .action-btn {
            width: 100%;
            text-align: center;
        }

        .grade-percentage {
            font-size: 48px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="review-container">
    <div class="review-content">
        <div class="review-header">
            <div class="header-top">
                <h1 class="exam-title">{{ submission.exam_name }}</h1>
                <a href="{% url 'exam_history' %}" class="back-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Takaisin
                </a>
            </div>

            {% if submission.exam_description %}
            <p class="exam-description">{{ submission.exam_description }}</p>
            {% endif %}

            <div class="exam-stats">
                <div class="stat-item">
                    <span class="stat-label">Suoritettu</span>
                    <span class="stat-value">{{ submission.submitted_at|date:"d.m.Y H:i" }}</span>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Kysymyksia</span>
                    <span class="stat-value">{{ submission.submission_data.questions|length }}</span>
                </div>

                {% if submission.time_taken %}
                <div class="stat-item">
                    <span class="stat-label">Kaytetty aika</span>
                    <span class="stat-value">
                        {% widthratio submission.time_taken 60 1 %} min
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Grading Summary -->
        <div class="grading-summary {% if not submission.is_graded %}not-graded{% endif %}">
            {% if submission.is_graded %}
            <div class="grading-header">
                <div class="grading-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Arviointi valmis
                </div>
                <span class="grading-badge">{{ submission.graded_at|date:"d.m.Y H:i" }}</span>
            </div>
            <div class="grade-display">
                <div class="grade-percentage">{{ submission.grade_percentage }}%</div>
                <div class="grade-points">{{ submission.total_points_earned|floatformat:1 }} / {{ submission.total_points_possible|floatformat:1 }} pistettä</div>
            </div>
            <div class="grade-bar">
                <div class="grade-bar-fill" style="width: {{ submission.grade_percentage }}%;"></div>
            </div>
            {% else %}
            <div class="not-graded-message">
                <div class="not-graded-icon">⏳</div>
                <div class="not-graded-text">Koetta ei ole vielä arvioitu</div>
            </div>
            {% endif %}
        </div>

        <div class="questions-section">
            {% for question in submission.submission_data.questions %}
            {% with grade=grades|default_if_none:""|dictsort:forloop.counter0 %}
            <div class="question-card {% if submission.is_graded %}{% if grades|length > forloop.counter0 %}{% with g=grades|get_item:forloop.counter0 %}{% if g.points_earned == g.points_possible %}graded-correct{% elif g.points_earned > 0 %}graded-partial{% else %}graded-incorrect{% endif %}{% endwith %}{% endif %}{% endif %}">
                <div class="question-header">
                    <span class="question-number">Kysymys {{ forloop.counter }}</span>

                    {% if submission.is_graded and forloop.counter0 in grades %}
                    {% with g=grades|get_item:forloop.counter0 %}
                    <span class="question-points {% if g.points_earned == g.points_possible %}points-full{% elif g.points_earned > 0 %}points-partial{% else %}points-zero{% endif %}">
                        {{ g.points_earned|floatformat:1 }} / {{ g.points_possible|floatformat:1 }} p
                    </span>
                    {% endwith %}
                    {% else %}
                    <span class="question-type">
                        {% if question.question_type == 'text' %}
                        Tekstivastaus
                        {% else %}
                        Monivalinta
                        {% endif %}
                    </span>
                    {% endif %}
                </div>

                <p class="question-text">{{ question.question_text|safe }}</p>

                {% if question.question_type == 'text' %}
                <div class="answer-section">
                    <div class="answer-label">Vastauksesi</div>
                    {% if question.answer %}
                    <div class="answer-text">{{ question.answer|safe }}</div>
                    {% else %}
                    <div class="answer-empty">Ei vastausta</div>
                    {% endif %}
                </div>
                {% else %}
                <div class="choices-list">
                    {% for choice in question.choices %}
                    <div class="choice-item {% if choice.choice_text in question.selected_answers %}selected{% endif %}">
                        <span class="choice-marker">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </span>
                        <span>{{ choice.choice_text|safe }}</span>
                    </div>
                    {% endfor %}
                </div>

                {% if not question.selected_answers %}
                <div class="no-answer">Ei valittu vastausta</div>
                {% endif %}
                {% endif %}

                <!-- Grading Feedback -->
                {% if submission.is_graded and forloop.counter0 in grades %}
                {% with g=grades|get_item:forloop.counter0 %}
                <div class="grading-section">
                    {% if g.feedback %}
                    <div class="feedback-box {% if g.points_earned == g.points_possible %}correct{% elif g.points_earned == 0 %}incorrect{% endif %}">
                        <div class="feedback-label {% if g.points_earned == g.points_possible %}correct{% elif g.points_earned > 0 %}partial{% else %}incorrect{% endif %}">
                            {% if g.points_earned == g.points_possible %}
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Oikein
                            {% elif g.points_earned > 0 %}
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            Osittain oikein
                            {% else %}
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                            Palaute
                            {% endif %}
                        </div>
                        <div class="feedback-text">{{ g.feedback|safe }}</div>
                    </div>
                    {% endif %}

                    {% if g.correct_answer %}
                    <div class="correct-answer-box">
                        <div class="correct-answer-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                            Mallivastaus
                        </div>
                        <div class="correct-answer-text">{{ g.correct_answer|safe }}</div>
                    </div>
                    {% endif %}
                </div>
                {% endwith %}
                {% endif %}
            </div>
            {% endwith %}
            {% endfor %}
        </div>

        <div class="footer-actions">
            <a href="{% url 'exam_history' %}" class="action-btn action-btn-secondary">Koehistoria</a>
            <a href="{% url 'create_exam' %}" class="action-btn action-btn-primary">Luo uusi koe</a>
        </div>
    </div>
</div>

<script>
// Trigger MathJax rendering when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise().catch(function(err) {
            console.log('MathJax typeset error:', err);
        });
    }
});
</script>
{% endblock %}
