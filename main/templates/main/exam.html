{% extends 'main/base.html' %}

{% block title %}<title>{{ exam.name }}</title>{% endblock %}

{% block css %}
    <!-- MathJax for rendering math in questions -->
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
        }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Digabi Rich Text Editor -->
    <link rel="stylesheet" type="text/css" href="https://math-demo.abitti.fi/dist/student.css"/>
    <script src="https://unpkg.com/rich-text-editor@8.1.7/dist/rich-text-editor-bundle.js"></script>

    <style>
        body {
            margin: 0;
            font-family: var(--font-family-primary);
            background-color: #f0f7f8;
            color: var(--color-text-dark);
        }

        /* Start Screen */
        .start-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--color-bg-gradient);
        }

        .start-card {
            background: var(--color-bg-white);
            border-radius: var(--radius-lg);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .start-card h1 {
            color: var(--color-text-primary);
            font-size: var(--text-4xl);
            margin: 0 0 10px 0;
            font-family: var(--font-family-heading);
            font-style: italic;
            letter-spacing: var(--tracking-tight);
        }

        .start-card .description {
            color: var(--color-text-muted);
            font-size: var(--text-base);
            line-height: var(--leading-relaxed);
            margin: 20px 0;
            white-space: pre-wrap;
        }

        .start-card .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .info-item {
            background: #f0f7f8;
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .info-item .label {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            margin-bottom: 8px;
            letter-spacing: var(--tracking-wide);
        }

        .info-item .value {
            color: var(--color-primary);
            font-size: var(--text-2xl);
            font-weight: bold;
        }

        .start-btn {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius-md);
            font-size: var(--text-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            margin-top: 20px;
            font-family: var(--font-family-primary);
            letter-spacing: var(--tracking-wide);
        }

        .start-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary);
        }

        /* Exam Container */
        .exam-container {
            display: none;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
        }

        .exam-container.active {
            display: flex;
        }

        /* Sidebar - positioned below the main navbar (56px) */
        .sidebar {
            width: 280px;
            background: var(--color-bg-white);
            padding: 20px;
            border-right: 1px solid var(--color-border-light);
            height: calc(100vh - 56px);
            overflow-y: auto;
            position: fixed;
            top: 56px;
            left: 0;
            display: flex;
            flex-direction: column;
        }

        /* Exam info in sidebar */
        .sidebar-exam-info {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--color-border-light);
        }

        .sidebar-exam-info h1 {
            color: var(--color-text-primary);
            font-size: var(--text-lg);
            margin: 0 0 8px 0;
            font-family: var(--font-family-heading);
            letter-spacing: var(--tracking-tight);
        }

        .sidebar-exam-info .exam-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sidebar-exam-info .question-count {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }

        .timer {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-primary);
            background: #f0f7f8;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-family: var(--font-family-primary);
        }

        .timer.warning {
            color: var(--color-error);
            background: var(--color-error-light);
        }

        .sidebar h2 {
            color: var(--color-text-primary);
            font-size: var(--text-base);
            margin: 0 0 12px 0;
            font-family: var(--font-family-heading);
            letter-spacing: var(--tracking-tight);
        }

        .question-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .question-nav-item {
            aspect-ratio: 1;
            border: 2px solid var(--color-border-light);
            background: var(--color-bg-white);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .question-nav-item:hover {
            border-color: var(--color-primary);
            background: #f0f7f8;
        }

        .question-nav-item.active {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .question-nav-item.answered {
            border-color: var(--color-success);
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .sidebar-instructions {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--color-border-light);
        }

        .sidebar-instructions h3 {
            font-size: var(--text-sm);
            color: var(--color-text-dark);
            margin: 0 0 8px 0;
            font-family: var(--font-family-heading);
        }

        .sidebar-instructions p {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            line-height: 1.5;
            margin: 0 0 12px 0;
        }

        .end-exam-btn {
            width: 100%;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: var(--font-family-primary);
        }

        .end-exam-btn:hover {
            background: var(--color-primary-dark);
        }

        /* Main content - below navbar (56px) only */
        .main-content {
            flex: 1;
            margin-left: 300px;
            margin-top: 56px;
            padding: 30px;
            overflow-y: auto;
            height: calc(100vh - 56px);
            max-width: 1200px;
        }

        .question-container {
            background: var(--color-bg-white);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            scroll-margin-top: 80px;
        }

        .question-container.in-view {
            border-left: 4px solid var(--color-primary);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-border-light);
        }

        .question-number {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-muted);
            letter-spacing: var(--tracking-wide);
        }

        .question-type {
            background: #f0f7f8;
            color: var(--color-primary);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: var(--tracking-wide);
        }

        .question-text {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: 20px;
            line-height: var(--leading-normal);
        }

        /* Text Answer - Rich Text Editor */
        .text-answer-wrapper {
            margin-top: 20px;
        }

        .answer-editor {
            border: 2px solid var(--color-border-light);
            border-radius: var(--radius-sm);
            background: white;
            overflow: visible;
        }

        .answer-editor:focus-within {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(90, 155, 168, 0.1);
        }

        /* Rich text editor internal structure */
        .answer-editor > div {
            display: flex;
            flex-direction: column;
        }

        /* Toolbar styling - give it proper height and prevent overlap */
        .answer-editor [data-testid="toolbar"] {
            position: relative !important;
            top: auto !important;
            z-index: 50 !important;
            min-height: 44px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--color-border-light);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        /* The actual editable text area */
        .answer-editor .answer {
            min-height: 200px;
            padding: 16px;
            outline: none;
            line-height: 1.6;
            overflow-y: auto;
        }

        /* Make text area expand as user types */
        .answer-editor .answer:empty::before {
            content: 'Kirjoita vastauksesi tähän... (Ctrl+E avataksesi kaavaeditorin)';
            color: var(--color-text-muted);
        }

        /* Images in editor - matching Digabi official styles */
        .answer-editor .answer img {
            padding: 5px;
            padding-top: 0px;
            padding-right: 0px;
            padding-bottom: 16px;
            max-width: 7%;
            max-height: 800px;
            width: calc(100% - 26px);
            vertical-align: left;
            max-height: 80px;
        }

        .answer-editor .answer img.equation {
            min-height: 32px;
            min-width: 57px;
            box-shadow: none;
            max-height: 60px;
        }

        /* ===== FORMULA EDITOR (KAAVAEDITORI) COMPLETE FIX ===== */

        /* The formula image - FIXED height, auto width, no shrinking */
        .answer-editor .answer img.equation,
        .answer-editor .answer img[src*="math.svg"] {
            height: 40px !important;
            width: auto !important;
            max-width: none !important;
            min-width: auto !important;
            display: inline !important;
            vertical-align: middle !important;
        }

        /* Math editor wrapper - don't constrain it */
        .math-editor-wrapper {
            display: contents !important;
        }

        /* The math editor popup container - same width as text box */
        .math-editor,
        .sc-gtLWhw {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* MathQuill input field - where you type - FULL WIDTH with horizontal scroll */
        .math-editor-equation-field,
        .sc-egkSDF {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            padding: 10px !important;
            overflow-x: auto !important;
            overflow-y: hidden !important;
            box-sizing: border-box !important;
        }

        /* MathQuill root block - the actual formula display while typing */
        .mq-root-block {
            font-size: 24px !important;
            white-space: nowrap !important;
            display: inline-block !important;
            width: auto !important;
            min-width: 100% !important;
        }

        /* MathQuill math mode - full width container */
        .mq-math-mode {
            font-size: 24px !important;
            width: 100% !important;
            overflow-x: auto !important;
        }

        /* LaTeX text field */
        .math-editor-latex-field,
        .sc-fAUdSK {
            width: 100% !important;
            font-size: 14px !important;
            font-family: monospace !important;
        }

        /* Answer area - left aligned */
        .answer-editor .answer {
            text-align: left !important;
        }

        /* Formula images - left aligned */
        .answer-editor .answer img.equation,
        .answer-editor .answer img[src*="math.svg"] {
            float: none !important;
            margin-left: 0 !important;
            margin-right: auto !important;
        }

        /* Toolbar icons - make sure they are visible */
        .rich-text-editor-tools,
        .rich-text-editor-tools button,
        .rich-text-editor-tools svg,
        .rich-text-editor-tools img,
        .rich-text-editor-tools span {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .rich-text-editor-tools button {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .rich-text-editor-tools svg {
            width: 20px !important;
            height: 20px !important;
            fill: currentColor !important;
            color: #333 !important;
        }

        .rich-text-editor-tools button:hover svg {
            color: #000 !important;
        }

        /* Multiple Choice */
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--color-border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            background: var(--color-bg-white);
        }

        .choice-item:hover {
            border-color: var(--color-primary);
            background: #f0f7f8;
        }

        .choice-item.selected {
            border-color: var(--color-primary);
            background: #f0f7f8;
        }

        .choice-item input[type="checkbox"],
        .choice-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--color-primary);
            pointer-events: none;
        }

        .choice-text {
            flex: 1;
            font-size: var(--text-base);
            color: var(--color-text-dark);
            line-height: var(--leading-normal);
        }

        /* Submit Section */
        .submit-section {
            background: var(--color-bg-white);
            padding: 25px;
            margin-top: 40px;
            margin-bottom: 25px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .submit-section p {
            color: var(--color-text-muted);
            line-height: var(--leading-relaxed);
            margin-bottom: 20px;
            font-size: var(--text-base);
        }

        .submit-btn {
            padding: 16px 32px;
            border: none;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-sm);
            font-size: var(--text-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            font-family: var(--font-family-primary);
            letter-spacing: var(--tracking-wide);
        }

        .submit-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-primary);
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: var(--color-success);
            color: white;
            border-radius: var(--radius-sm);
            font-weight: 600;
            opacity: 0;
            transition: opacity var(--transition-normal);
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
        }
    </style>
{% endblock %}

{% block content %}
<!-- Start Screen -->
<div class="start-screen" id="startScreen">
    <div class="start-card">
        <h1>{{ exam.name }}</h1>
        {% if exam.description %}
        <div class="description">{{ exam.description }}</div>
        {% endif %}

        <div class="info-grid">
            <div class="info-item">
                <div class="label">Kysymyksiä</div>
                <div class="value">{{ questions.count }}</div>
            </div>
            <div class="info-item">
                <div class="label">Aikaraja</div>
                <div class="value">
                    {% if exam.time_limit %}
                        {{ exam.time_limit|floatformat:0|add:"0"|divisibleby:"60"|yesno:"0," }}{% widthratio exam.time_limit 60 1 %} min
                    {% else %}
                        Ei rajaa
                    {% endif %}
                </div>
            </div>
        </div>

        <button class="start-btn" onclick="startExam()">
            {% if exam.time_limit %}Aloita koe{% else %}Aloita koe{% endif %}
        </button>
    </div>
</div>

<!-- Exam Container -->
<div class="exam-container" id="examContainer">
    <!-- Sidebar with exam info, nav, and controls -->
    <aside class="sidebar">
        <div class="sidebar-exam-info">
            <h1>{{ exam.name }}</h1>
            <div class="exam-meta">
                <span class="question-count">{{ questions.count }} kysymystä</span>
                {% if exam.time_limit %}
                <div class="timer" id="timer">--:--</div>
                {% endif %}
            </div>
        </div>

        <h2>Kysymykset</h2>
        <div class="question-nav" id="questionNav"></div>

        <div class="sidebar-instructions">
            <h3>Ohjeet</h3>
            <p>Siirry kysymysten välillä ylläolevan ruudukon avulla. Vastauksesi tallentuvat automaattisesti.</p>
            <form method="post" action="{% url 'end_exam' exam.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="end-exam-btn" onclick="return confirm('Haluatko varmasti päättää kokeen?')">Päätä koe</button>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        {% for item in questions_with_answers %}
        <div class="question-container" id="question-{{ forloop.counter }}" data-question-id="{{ item.question.id }}" data-index="{{ forloop.counter0 }}">
            <div class="question-header">
                <span class="question-number">Kysymys {{ forloop.counter }} / {{ questions.count }}</span>
                <span class="question-type">{{ item.question.question_type }}</span>
            </div>

            <div class="question-text">{{ item.question.question_text|safe }}</div>

            {% if item.question.question_type == 'text' %}
            <div class="text-answer-wrapper">
                <div class="answer-editor"
                     id="answer-{{ item.question.id }}"
                     data-question-id="{{ item.question.id }}">{{ item.answer|safe }}</div>
            </div>
            {% else %}
            <div class="choices-container">
                {% for choice in item.question.choices.all %}
                <label class="choice-item" data-choice-id="{{ choice.id }}">
                    <input type="checkbox" value="{{ choice.id }}" data-question-id="{{ item.question.id }}">
                    <span class="choice-text">{{ choice.choice_text }}</span>
                </label>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}

        <!-- Submit Section -->
        <div class="submit-section">
            <p>
                Tarkista vastauksesi ennen lähettämistä. Varmista, että olet vastannut kaikkiin kysymyksiin.
                Vastauksesi on tallennettu automaattisesti.
            </p>
            <form method="post" action="{% url 'end_exam' exam.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="submit-btn" onclick="return confirm('Haluatko varmasti palauttaa kokeen? Tätä ei voi perua.')">Palauta koe</button>
            </form>
        </div>
    </div>
</div>

<!-- Save Indicator -->
<div class="save-indicator" id="saveIndicator">Tallennettu</div>

<script>
const examId = {{ exam.id }};
const timeLimit = {% if time_remaining %}{{ time_remaining|floatformat:0 }}{% elif exam.time_limit %}{{ exam.time_limit }}{% else %}null{% endif %};
const startedAt = {% if started_at %}'{{ started_at }}'{% else %}null{% endif %};
const answers = {{ answers_json|safe }};

let saveTimeout = null;
let timerInterval = null;
let scrollTimeout = null;
const editors = {};

function startExam() {
    console.log('Starting exam...');

    fetch(`/exam/{{ exam.id }}/start/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Exam started:', data);
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('examContainer').classList.add('active');

        initializeExam();

        if (data.time_limit) {
            const startTime = new Date(data.started_at);
            const endTime = new Date(startTime.getTime() + data.time_limit * 1000);
            startTimer(endTime);
        }
    })
    .catch(error => {
        console.error('Error starting exam:', error);
        alert('Kokeen aloitus epäonnistui. Yritä uudelleen.');
    });
}

function initializeExam() {
    console.log('Initializing exam interface...');

    buildQuestionNav();
    initializeEditors();
    attachEventListeners();
    loadSavedAnswers();
    setupScrollTracking();

    setTimeout(() => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
    }, 500);
}

function initializeEditors() {
    if (typeof window.makeRichText === 'undefined') {
        console.log('Waiting for rich-text-editor to load...');
        setTimeout(initializeEditors, 100);
        return;
    }

    document.querySelectorAll('.answer-editor').forEach(container => {
        if (container.dataset.initialized) return;

        const questionId = container.dataset.questionId;
        container.dataset.initialized = 'true';
        editors[questionId] = container;

        window.makeRichText({
            container: container,
            language: 'FI',
            baseUrl: 'https://math-demo.abitti.fi',
            onValueChange: (value) => {
                // Extract answerHtml if the value is an object (Digabi editor returns object)
                const htmlContent = (value && typeof value === 'object' && value.answerHtml)
                    ? value.answerHtml
                    : value;
                answers[questionId] = htmlContent;
                autoSave(questionId, htmlContent);
                updateQuestionNav();
                // Auto-expand the text area
                autoExpandEditor(container);
            }
        });

        // Set up auto-expand on the answer area
        setTimeout(() => {
            const answerArea = container.querySelector('.answer');
            if (answerArea) {
                autoExpandEditor(container);
            }
        }, 200);
    });
}

function autoExpandEditor(container) {
    const answerArea = container.querySelector('.answer');
    if (answerArea) {
        // Reset height to auto to measure content
        answerArea.style.height = 'auto';
        // Set minimum height of 200px, or content height if larger
        const contentHeight = answerArea.scrollHeight;
        answerArea.style.height = Math.max(200, contentHeight) + 'px';
    }
}

function buildQuestionNav() {
    const nav = document.getElementById('questionNav');
    const questions = document.querySelectorAll('.question-container');

    nav.innerHTML = '';
    questions.forEach((q, index) => {
        const btn = document.createElement('div');
        btn.className = 'question-nav-item';
        btn.textContent = index + 1;
        btn.onclick = () => scrollToQuestion(index + 1);
        nav.appendChild(btn);
    });

    updateQuestionNav();
}

function scrollToQuestion(questionNumber) {
    const questionElement = document.getElementById(`question-${questionNumber}`);
    if (questionElement) {
        questionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function setupScrollTracking() {
    const mainContent = document.getElementById('mainContent');
    const options = {
        root: mainContent,
        rootMargin: '-120px 0px -60% 0px',
        threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const index = parseInt(entry.target.dataset.index);
                updateActiveQuestion(index);
            }
        });
    }, options);

    document.querySelectorAll('.question-container').forEach(question => {
        observer.observe(question);
    });
}

function updateActiveQuestion(index) {
    const navItems = document.querySelectorAll('.question-nav-item');
    navItems.forEach((item, i) => {
        if (i === index) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function loadSavedAnswers() {
    console.log('Loading saved answers:', answers);

    // Load multiple choice answers
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        const questionId = checkbox.dataset.questionId;
        const choiceId = parseInt(checkbox.value);

        if (answers[questionId] && Array.isArray(answers[questionId]) && answers[questionId].includes(choiceId)) {
            checkbox.checked = true;
            checkbox.closest('.choice-item').classList.add('selected');
        }
    });

    // Text answers are loaded via the initial HTML content in the div
    // The rich-text-editor reads the innerHTML on initialization

    updateQuestionNav();
}

function attachEventListeners() {
    // Text answer listeners are handled in initializeEditors()
    // Handle multiple choice clicks here
    document.querySelectorAll('.choice-item').forEach(item => {
        item.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                handleCheckboxChange(checkbox);
            }
        });
    });
}

function handleCheckboxChange(checkbox) {
    const questionId = checkbox.dataset.questionId;
    const choiceId = parseInt(checkbox.value);

    console.log('=== CHECKBOX CHANGE ===');
    console.log('Question ID:', questionId);
    console.log('Choice ID:', choiceId);
    console.log('Checked:', checkbox.checked);

    if (!answers[questionId]) {
        answers[questionId] = [];
    }

    if (checkbox.checked) {
        if (!answers[questionId].includes(choiceId)) {
            answers[questionId].push(choiceId);
        }
        checkbox.closest('.choice-item').classList.add('selected');
        console.log('Added selected class');
    } else {
        answers[questionId] = answers[questionId].filter(id => id !== choiceId);
        checkbox.closest('.choice-item').classList.remove('selected');
        console.log('Removed selected class');
    }

    console.log('Answers array:', answers[questionId]);
    console.log('Saving to server...');

    autoSave(questionId, answers[questionId]);
    updateQuestionNav();
}

function updateQuestionNav() {
    const navItems = document.querySelectorAll('.question-nav-item');
    const questionContainers = document.querySelectorAll('.question-container');

    navItems.forEach((item, index) => {
        // Don't remove 'active' class here - it's managed by scroll tracking
        item.classList.remove('answered');

        const questionContainer = questionContainers[index];
        const questionId = questionContainer.dataset.questionId;

        if (answers[questionId]) {
            if (Array.isArray(answers[questionId])) {
                if (answers[questionId].length > 0) {
                    item.classList.add('answered');
                }
            } else if (answers[questionId].toString().trim() !== '') {
                item.classList.add('answered');
            }
        }
    });
}

function autoSave(questionId, answer) {
    clearTimeout(saveTimeout);

    saveTimeout = setTimeout(() => {
        console.log('Auto-saving:', {questionId, answer});

        fetch('/api/save-answer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exam_id: examId,
                question_id: questionId,
                answer: answer
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Save response:', data);
            if (data.status === 'success') {
                showSaveIndicator();
            }
        })
        .catch(error => {
            console.error('Error saving answer:', error);
        });
    }, 300);
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function startTimer(endTime) {
    const timerElement = document.getElementById('timer');
    if (!timerElement) return;

    function updateTimer() {
        const now = new Date();
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000));

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;

        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (remaining < 300) {
            timerElement.classList.add('warning');
        }

        if (remaining === 0) {
            clearInterval(timerInterval);
            alert('Aika loppui! Kokeesi palautetaan nyt.');
            document.querySelector('.end-exam-btn').click();
        }
    }

    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}

if (startedAt && timeLimit) {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('examContainer').classList.add('active');
    initializeExam();

    const startTime = new Date(startedAt);
    const endTime = new Date(startTime.getTime() + (timeLimit * 1000));
    startTimer(endTime);
} else {
    setTimeout(() => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
    }, 500);
}
</script>
{% endblock %}
