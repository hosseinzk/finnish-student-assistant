{% extends "main/base.html" %}

{% block title %}<title>{{ exam.name }}</title>{% endblock %}

{% block extra_css %}
<script>
window.MathJax = {
  tex: {
    inlineMath: [['\\(', '\\)'], ['$', '$']],
    displayMath: [['\\[', '\\]'], ['$$', '$$']],
    processEscapes: true
  },
  startup: {
    typeset: false
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
    :root {
        --primary-blue: #2563eb;
        --light-blue: #3b82f6;
        --lighter-blue: #60a5fa;
        --very-light-blue: #dbeafe;
        --white: #ffffff;
        --text-dark: #1e293b;
        --text-gray: #64748b;
        --border-color: #e2e8f0;
        --success-green: #10b981;
        --unanswered: #fbbf24;
    }

    body {
        background-color: var(--very-light-blue);
        color: var(--text-dark);
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .start-screen {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--very-light-blue) 0%, var(--white) 100%);
    }

    .start-card {
        background: var(--white);
        border-radius: 16px;
        padding: 40px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(37, 99, 235, 0.1);
    }

    .start-card h1 {
        color: var(--primary-blue);
        font-size: 32px;
        margin: 0 0 10px 0;
    }

    .start-card .description {
        color: var(--text-gray);
        font-size: 16px;
        line-height: 1.6;
        margin: 20px 0;
        white-space: pre-wrap;
    }

    .start-card .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 30px 0;
    }

    .info-item {
        background: var(--very-light-blue);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
    }

    .info-item .label {
        color: var(--text-gray);
        font-size: 14px;
        margin-bottom: 8px;
    }

    .info-item .value {
        color: var(--primary-blue);
        font-size: 24px;
        font-weight: bold;
    }

    .start-btn {
        width: 100%;
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 20px;
    }

    .start-btn:hover {
        background: var(--light-blue);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
    }

    .exam-container {
        display: none;
        flex-direction: row;
        height: 100vh;
        overflow: hidden;
    }

    .exam-container.active {
        display: flex;
    }

    .exam-header {
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        background: var(--white);
        padding: 20px 30px;
        border-bottom: 2px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .exam-info h1 {
        color: var(--primary-blue);
        font-size: 24px;
        margin: 0 0 5px 0;
    }

    .exam-info p {
        color: var(--text-gray);
        font-size: 14px;
        margin: 0;
    }

    .exam-controls {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .timer {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-blue);
        background: var(--very-light-blue);
        padding: 10px 20px;
        border-radius: 8px;
        min-width: 120px;
        text-align: center;
    }

    .timer.warning {
        color: #dc2626;
        background: #fee2e2;
    }

    .end-exam-btn {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
    }

    .end-exam-btn:hover {
        background: var(--light-blue);
    }

    .sidebar {
        width: 280px;
        background: var(--white);
        border-right: 2px solid var(--border-color);
        padding: 20px;
        overflow-y: auto;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
    }

    .sidebar h2 {
        color: var(--primary-blue);
        font-size: 18px;
        margin: 0 0 20px 0;
    }

    .question-nav {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    .question-nav-item {
        aspect-ratio: 1;
        border: 2px solid var(--border-color);
        background: var(--white);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .question-nav-item:hover {
        border-color: var(--lighter-blue);
        background: var(--very-light-blue);
    }

    .question-nav-item.active {
        border-color: var(--primary-blue);
        background: var(--primary-blue);
        color: white;
    }

    .question-nav-item.answered {
        border-color: var(--success-green);
        background: #d1fae5;
        color: var(--success-green);
    }

    .main-content {
        flex: 1;
        margin-left: 280px;
        margin-top: 100px;
        padding: 30px;
        overflow-y: auto;
        height: calc(100vh - 100px);
    }

    .question-container {
        display: none;
        background: var(--white);
        border-radius: 12px;
        padding: 40px;
        max-width: 900px;
        margin: 0 auto;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .question-container.active {
        display: block;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
    }

    .question-number {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
    }

    .question-type {
        background: var(--very-light-blue);
        color: var(--primary-blue);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .question-text {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 30px;
        line-height: 1.5;
    }

    .text-answer-wrapper {
        margin-top: 20px;
    }

    .formatting-toolbar {
        display: flex;
        gap: 5px;
        padding: 10px;
        background: #f8fafc;
        border: 2px solid var(--border-color);
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }

    .format-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .format-btn:hover {
        background: var(--very-light-blue);
        border-color: var(--primary-blue);
    }

    .text-answer {
        width: 100%;
        min-height: 400px;
        padding: 20px;
        border: 2px solid var(--border-color);
        border-radius: 0 0 8px 8px;
        border-top: none;
        font-size: 16px;
        font-family: inherit;
        line-height: 1.6;
        resize: vertical;
    }

    .text-answer:focus {
        outline: none;
        border-color: var(--primary-blue);
    }


    .choices-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .choice-item {
        display: flex;
        align-items: center;
        padding: 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--white);
    }

    .choice-item:hover {
        border-color: var(--lighter-blue);
        background: var(--very-light-blue);
    }

    .choice-item.selected {
        border-color: var(--primary-blue);
        background: var(--very-light-blue);
    }

    .choice-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 15px;
        cursor: pointer;
        accent-color: var(--primary-blue);
        pointer-events: none;
    }

    .choice-text {
        flex: 1;
        font-size: 16px;
        color: var(--text-dark);
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid var(--border-color);
    }

    .nav-btn {
        padding: 12px 24px;
        border: 2px solid var(--primary-blue);
        background: white;
        color: var(--primary-blue);
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
        background: var(--primary-blue);
        color: white;
    }

    .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: var(--success-green);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1000;
    }

    .save-indicator.show {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="start-screen" id="startScreen">
    <div class="start-card">
        <h1>{{ exam.name }}</h1>
        {% if exam.description %}
        <div class="description">{{ exam.description }}</div>
        {% endif %}

        <div class="info-grid">
            <div class="info-item">
                <div class="label">Total Questions</div>
                <div class="value">{{ questions.count }}</div>
            </div>
            <div class="info-item">
                <div class="label">Time Limit</div>
                <div class="value">
                    {% if exam.time_limit %}
                        {{ exam.time_limit|floatformat:0|add:"0"|divisibleby:"60"|yesno:"0," }}{% widthratio exam.time_limit 60 1 %} min
                    {% else %}
                        No Limit
                    {% endif %}
                </div>
            </div>
        </div>

        <button class="start-btn" onclick="startExam()">
            {% if exam.time_limit %}Start Exam{% else %}Begin Exam{% endif %}
        </button>
    </div>
</div>

<div class="exam-container" id="examContainer">
    <div class="sidebar">
        <h2>Questions</h2>
        <div class="question-nav" id="questionNav"></div>
    </div>

    <div class="exam-header">
        <div class="exam-info">
            <h1>{{ exam.name }}</h1>
            <p>Question <span id="currentQuestionDisplay">1</span> of {{ questions.count }}</p>
        </div>
        <div class="exam-controls">
            {% if exam.time_limit %}
            <div class="timer" id="timer">--:--</div>
            {% endif %}
            <form method="post" action="{% url 'end_exam' exam.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="end-exam-btn" onclick="return confirm('Are you sure you want to end the exam?')">End Exam</button>
            </form>
        </div>
    </div>

    <div class="main-content">
        {% for item in questions_with_answers %}
        <div class="question-container" data-question-id="{{ item.question.id }}">
            <div class="question-header">
                <span class="question-number">Question {{ forloop.counter }} of {{ questions.count }}</span>
                <span class="question-type">{{ item.question.question_type }}</span>
            </div>

            <div class="question-text">{{ item.question.question_text|safe }}</div>

            {% if item.question.question_type == 'text' %}
            <div class="text-answer-wrapper">
                <div class="formatting-toolbar" id="toolbar-{{ item.question.id }}">
                    <button class="format-btn" onclick="formatText({{ item.question.id }}, 'bold')" type="button" title="Bold"><strong>B</strong></button>
                    <button class="format-btn" onclick="formatText({{ item.question.id }}, 'italic')" type="button" title="Italic"><em>I</em></button>
                    <button class="format-btn" onclick="formatText({{ item.question.id }}, 'underline')" type="button" title="Underline"><u>U</u></button>
                    <button class="format-btn" onclick="formatText({{ item.question.id }}, 'bullet')" type="button" title="Bullet List">• List</button>
                    <button class="format-btn" onclick="formatText({{ item.question.id }}, 'number')" type="button" title="Numbered List">1. List</button>
                </div>
                <textarea class="text-answer" id="text-answer-{{ item.question.id }}" data-question-id="{{ item.question.id }}" placeholder="Type your answer here...">{{ item.answer|safe }}</textarea>
            </div>
            {% else %}
            <div class="choices-container">
                {% for choice in item.question.choices.all %}
                <label class="choice-item" data-choice-id="{{ choice.id }}">
                    <input type="checkbox" value="{{ choice.id }}" data-question-id="{{ item.question.id }}">
                    <span class="choice-text">{{ choice.choice_text }}</span>
                </label>
                {% endfor %}
            </div>
            {% endif %}

            <div class="navigation-buttons">
                <button class="nav-btn" onclick="previousQuestion()" id="prevBtn{{ forloop.counter0 }}">Previous</button>
                {% if forloop.last %}
                <form method="post" action="{% url 'end_exam' exam.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn" style="background: var(--primary-blue); color: white;" onclick="return confirm('Are you sure you want to end the exam?')">End Exam</button>
                </form>
                {% else %}
                <button class="nav-btn" onclick="nextQuestion()" id="nextBtn{{ forloop.counter0 }}">Next</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="save-indicator" id="saveIndicator">Saved</div>

<script>
const examId = {{ exam.id }};
const timeLimit = {% if time_remaining %}{{ time_remaining|floatformat:0 }}{% elif exam.time_limit %}{{ exam.time_limit }}{% else %}null{% endif %};
const startedAt = {% if started_at %}'{{ started_at }}'{% else %}null{% endif %};
const answers = {{ answers_json|safe }};

let currentQuestion = 0;
let saveTimeout = null;
let timerInterval = null;
let richTextEditors = {};

function startExam() {
    console.log('Starting exam...');

    fetch(`/exam/{{ exam.id }}/start/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Exam started:', data);
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('examContainer').classList.add('active');

        initializeExam();

        if (data.time_limit) {
            const startTime = new Date(data.started_at);
            const endTime = new Date(startTime.getTime() + data.time_limit * 1000);
            startTimer(endTime);
        }
    })
    .catch(error => {
        console.error('Error starting exam:', error);
        alert('Failed to start exam. Please try again.');
    });
}

function initializeExam() {
    console.log('Initializing exam interface...');

    buildQuestionNav();
    showQuestion(0);
    attachEventListeners();
    loadSavedAnswers();

    setTimeout(() => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
    }, 500);
}

function formatText(questionId, format) {
    const textarea = document.getElementById(`text-answer-${questionId}`);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    if (!selectedText) {
        alert('Please select text first');
        return;
    }

    let formattedText = '';

    switch(format) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'underline':
            formattedText = `__${selectedText}__`;
            break;
        case 'bullet':
            const bulletLines = selectedText.split('\n').map(line => line.trim() ? `• ${line}` : line).join('\n');
            formattedText = bulletLines;
            break;
        case 'number':
            const numberLines = selectedText.split('\n').filter(line => line.trim());
            formattedText = numberLines.map((line, i) => `${i + 1}. ${line}`).join('\n');
            break;
    }

    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.selectionStart = start;
    textarea.selectionEnd = start + formattedText.length;
    textarea.focus();

    const questionIdStr = textarea.dataset.questionId;
    answers[questionIdStr] = textarea.value;
    autoSave(questionIdStr, textarea.value);
    updateQuestionNav();
}

function buildQuestionNav() {
    const nav = document.getElementById('questionNav');
    const questions = document.querySelectorAll('.question-container');

    nav.innerHTML = '';
    questions.forEach((q, index) => {
        const btn = document.createElement('div');
        btn.className = 'question-nav-item';
        btn.textContent = index + 1;
        btn.onclick = () => goToQuestion(index);
        nav.appendChild(btn);
    });

    updateQuestionNav();
}

function loadSavedAnswers() {
    console.log('Loading saved answers:', answers);

    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        const questionId = checkbox.dataset.questionId;
        const choiceId = parseInt(checkbox.value);

        if (answers[questionId] && Array.isArray(answers[questionId]) && answers[questionId].includes(choiceId)) {
            checkbox.checked = true;
            checkbox.closest('.choice-item').classList.add('selected');
        }
    });

    updateQuestionNav();
}

function attachEventListeners() {
    document.querySelectorAll('.text-answer').forEach(textarea => {
        textarea.addEventListener('input', function() {
            const questionId = this.dataset.questionId;
            const content = this.value;
            answers[questionId] = content;
            autoSave(questionId, content);
            updateQuestionNav();
        });
    });

    document.querySelectorAll('.choice-item').forEach(item => {
        item.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                handleCheckboxChange(checkbox);
            }
        });
    });
}

function handleCheckboxChange(checkbox) {
    const questionId = checkbox.dataset.questionId;
    const choiceId = parseInt(checkbox.value);

    console.log('=== CHECKBOX CHANGE ===');
    console.log('Question ID:', questionId);
    console.log('Choice ID:', choiceId);
    console.log('Checked:', checkbox.checked);

    if (!answers[questionId]) {
        answers[questionId] = [];
    }

    if (checkbox.checked) {
        if (!answers[questionId].includes(choiceId)) {
            answers[questionId].push(choiceId);
        }
        checkbox.closest('.choice-item').classList.add('selected');
        console.log('Added selected class');
    } else {
        answers[questionId] = answers[questionId].filter(id => id !== choiceId);
        checkbox.closest('.choice-item').classList.remove('selected');
        console.log('Removed selected class');
    }

    console.log('Answers array:', answers[questionId]);
    console.log('Saving to server...');

    autoSave(questionId, answers[questionId]);
    updateQuestionNav();
}

function showQuestion(index) {
    const questions = document.querySelectorAll('.question-container');
    questions.forEach(q => q.classList.remove('active'));

    if (questions[index]) {
        questions[index].classList.add('active');
        currentQuestion = index;
        document.getElementById('currentQuestionDisplay').textContent = index + 1;
        updateQuestionNav();

        setTimeout(() => {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([questions[index]]).catch((err) => console.log('MathJax error:', err));
            }
        }, 100);
    }
}

function goToQuestion(index) {
    showQuestion(index);
}

function nextQuestion() {
    const questions = document.querySelectorAll('.question-container');
    if (currentQuestion < questions.length - 1) {
        showQuestion(currentQuestion + 1);
    }
}

function previousQuestion() {
    if (currentQuestion > 0) {
        showQuestion(currentQuestion - 1);
    }
}

function updateQuestionNav() {
    const navItems = document.querySelectorAll('.question-nav-item');
    navItems.forEach((item, index) => {
        item.classList.remove('active', 'answered');

        if (index === currentQuestion) {
            item.classList.add('active');
        }

        const questionContainer = document.querySelectorAll('.question-container')[index];
        const questionId = questionContainer.dataset.questionId;

        if (answers[questionId]) {
            if (Array.isArray(answers[questionId])) {
                if (answers[questionId].length > 0) {
                    item.classList.add('answered');
                }
            } else if (answers[questionId].toString().trim() !== '') {
                item.classList.add('answered');
            }
        }
    });
}

function autoSave(questionId, answer) {
    clearTimeout(saveTimeout);

    saveTimeout = setTimeout(() => {
        console.log('Auto-saving:', {questionId, answer});

        fetch('/api/save-answer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exam_id: examId,
                question_id: questionId,
                answer: answer
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Save response:', data);
            if (data.status === 'success') {
                showSaveIndicator();
            }
        })
        .catch(error => {
            console.error('Error saving answer:', error);
        });
    }, 300);
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function startTimer(endTime) {
    const timerElement = document.getElementById('timer');
    if (!timerElement) return;

    function updateTimer() {
        const now = new Date();
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000));

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;

        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (remaining < 300) {
            timerElement.classList.add('warning');
        }

        if (remaining === 0) {
            clearInterval(timerInterval);
            alert('Time is up! Your exam will now be submitted.');
            document.querySelector('.end-exam-btn').click();
        }
    }

    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}

if (startedAt && timeLimit) {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('examContainer').classList.add('active');
    initializeExam();

    const startTime = new Date(startedAt);
    const endTime = new Date(startTime.getTime() + (timeLimit * 1000));
    startTimer(endTime);
} else {
    setTimeout(() => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
    }, 500);
}
</script>
{% endblock %}
